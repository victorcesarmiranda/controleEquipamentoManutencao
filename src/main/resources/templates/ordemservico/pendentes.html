<html lang="pt-BR">
<head th:replace="~{base :: head}"></head>
<body onload="onLoad()">
    <div th:replace="~{base :: logo}"></div>
    <div class="container" id="ordens-servico">
        <div th:replace="~{base :: titulo('Pendentes')}"></div>
        <div class="card mb-3" v-for="ordem in ordens" :key="ordem.id">
            <div class="card-header alert-warning">{{ordem.nomeCliente}}</div>
            <div class="card-body">
                <div class="row">
                    <div class="col">
                        <div class="text-start">
                            Peça: {{ordem.nomePeca}}
                        </div>
                    </div>
                    <div class="col">
                        <div class="text-start ">
                            Data de Cadastro: {{ordem.dataCadastro}}
                        </div>

                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col">
                        <div class="text-start">
                            Tipo da Peça:   {{ordem.tipoPeca}}
                        </div>
                    </div>
                    <div class="col">
                        <div class="text-start">
                            Marca:  {{ordem.marcaPeca}}
                        </div>
                    </div>
                </div>
                <label class="form-label mt-3">Descrição do problema:</label>
                <div class="text-start">
                    {{ordem.descricao}}
                </div>
                <div class="row">
                    <div class="mt-3 col">
                        <label for="dataInicio" class="form-label">Data Início</label>
                        <input id="dataInicio" type="datetime-local" class="form-control" v-model="ordem.dataInicio"
                               v-bind:class="{'is-invalid':ordem.erros.dataInicio !==''}"/>
                        <div v-if="ordem.erros.dataInicio" class="invalid-feedback">
                            {{ordem.erros.dataInicio}}
                        </div>
                    </div>
                    <div class="mt-3 col">
                        <label for="dataTermino" class="form-label">Data Término</label>
                        <input id="dataTermino" type="datetime-local" class="form-control"
                               v-model="ordem.dataTermino"/>
                    </div>
                </div>
                <div class="mt-3 col">
                    <label for="comentario" class="form-label">Comentário</label>
                    <textarea id="comentario" class="form-control"
                              placeholder="detalhes da execução da ordem de serviço"
                              maxlength="500"
                              v-model="ordem.comentario"></textarea>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-between">
                    <div>
                        <button v-if="ordem.iniciada" class="btn btn-success mt-4">Iniciada</button>
                        <button v-else class="btn btn-primary mt-4" v-on:click="iniciaOrdemServico(ordem)">Iniciar</button>
                    </div>
                    <div>
                        <button type="button" class="btn btn-danger mt-4" data-bs-toggle="modal" data-bs-target="#confirmacaoDeleta">Deletar</button>
                    </div>
                    <div class="modal fade" id="formularioEditar" tabindex="-1" aria-labelledby="editarOdemServico" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="editarOdemServico">Editar Ordem de Serviço</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                                </div>
                                <div class="modal-body">
                                    <p class="text-center text-wrap">Você tem certeza que deseja deletar esta Ordem de Serviço?</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                    <button class="btn btn-secondary" data-bs-dismiss="modal" v-on:click="editarOrdemServico(ordem)">Editar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal fade" id="confirmacaoDeleta" tabindex="-1" aria-labelledby="deletarOdemServico" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="deletarOdemServico">Deletar Ordem de Serviço?</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                                </div>
                                <div class="modal-body">
                                    <p class="text-center text-wrap">Você tem certeza que deseja deletar esta Ordem de Serviço?</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                                    <button class="btn btn-danger" data-bs-dismiss="modal" v-on:click="deletarOrdemServico(ordem)">Deletar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        function onLoad() {
            var app = new Vue(
                {
                    el: '#ordens-servico',
                    data: {
                        ordens: []
                    },
                    mounted () {
                        axios
                            .get('http://localhost:8080/api/ordemservico/pendente')
                            .then(response => {
                                response.data.forEach(ordem =>{
                                    ordem.iniciada = false;
                                    ordem.erros = {
                                        dataInicio: ''
                                    }
                                })
                                this.ordens = response.data
                            })
                    },
                    methods: {
                        iniciaOrdemServico: function (ordemServico) {
                            ordemServico.erros = {
                                dataInicio: ''
                            };
                            axios
                                .post('http://localhost:8080/api/ordemservico/iniciar', {
                                    id: ordemServico.id,
                                    dataInicio: ordemServico.dataInicio,
                                    dataTermino: ordemServico.dataTermino,
                                    comentario: ordemServico.comentario
                                })
                                .then(response => ordemServico.iniciada = true)
                                .catch(error => {
                                    error.response.data.errors.forEach(error => ordemServico.erros[error.field] = error.defaultMessage)
                                })
                        },
                        deletarOrdemServico: function (ordemServico) {
                            axios
                                .delete('http://localhost:8080/api/ordemservico/deletar/' + ordemServico.id)
                                .then(response => this.ordens.splice(this.ordens.indexOf(ordemServico), 1))
                                .catch(error => {
                                    console.log(error)
                                })
                        }
                    }
                });
        }
    </script>

</body>
</html>